<UserControl x:Class="ProjectReport.Views.GeometryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:geometry="clr-namespace:ProjectReport.Views.Geometry"
             xmlns:converters="clr-namespace:ProjectReport.Converters"
             xmlns:wb="clr-namespace:ProjectReport.Models.Geometry.Wellbore"
             xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
             mc:Ignorable="d"
             d:DesignHeight="800"
             d:DesignWidth="1200"
             Loaded="GeometryView_Loaded"
             KeyDown="GeometryView_KeyDown">

    <UserControl.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:CollectionToVisibilityConverter x:Key="CollectionToVis"/>
        <converters:NullToVisibilityConverter x:Key="NullToVis"/>
        <converters:BoolToGreenRedConverter x:Key="BoolToGreenRedConverter"/>
        <converters:BitStatusConverter x:Key="BitStatusConverter"/>
        
        <CollectionViewSource x:Key="AnnularDetailsView" Source="{Binding AnnularVolumeDetails}">
            <CollectionViewSource.GroupDescriptions>
                <PropertyGroupDescription PropertyName="Stage"/>
            </CollectionViewSource.GroupDescriptions>
        </CollectionViewSource>


        <!-- Tokens -->
        <SolidColorBrush x:Key="AppBg" Color="#F7F8FA"/>
        <SolidColorBrush x:Key="Surface" Color="White"/>
        <SolidColorBrush x:Key="BorderSoft" Color="#E6E8EB"/>
        <SolidColorBrush x:Key="TextMuted" Color="#6B7280"/>
        <SolidColorBrush x:Key="DisabledText" Color="#9CA3AF"/>
        <SolidColorBrush x:Key="TextStrong" Color="#111827"/>
        <SolidColorBrush x:Key="BrandOrange" Color="#F57C1F"/>
        <SolidColorBrush x:Key="BrandOrangeHover" Color="#EF6C00"/>
        <SolidColorBrush x:Key="BrandOrangePressed" Color="#E65100"/>
        <SolidColorBrush x:Key="Danger" Color="#DC2626"/>
        <SolidColorBrush x:Key="Warn" Color="#D97706"/>
        <SolidColorBrush x:Key="Success" Color="#16A34A"/>
        <SolidColorBrush x:Key="BrandBlue" Color="#0062FF"/>

        <!-- Gradients -->
        <LinearGradientBrush x:Key="BrandBlueGradient" StartPoint="0,0.5" EndPoint="1,0.5">
            <GradientStop Color="#0062FF" Offset="0"/>
            <GradientStop Color="#00C2FF" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="BrandOrangeGradient" StartPoint="0,0.5" EndPoint="1,0.5">
            <GradientStop Color="#F57C1F" Offset="0"/>
            <GradientStop Color="#FFB74D" Offset="1"/>
        </LinearGradientBrush>

        <!-- Card -->
        <Style x:Key="CardBorder" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource Surface}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="14"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>

        <Style x:Key="CardHeader" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource TextStrong}"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>

        <!-- Buttons -->
        <!-- Buttons (solo UI, sin tocar lógica) -->
        <Style x:Key="BrandPrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource BrandOrange}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BrandOrange}"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="16,10"/>
            <Setter Property="MinHeight" Value="40"/>
            <Setter Property="MinWidth" Value="130"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10"
                                                ShadowDepth="2"
                                                Opacity="0.18"/>
                            </Border.Effect>
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            RecognizesAccessKey="True"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BrandOrangeHover}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BrandOrangeHover}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BrandOrangePressed}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BrandOrangePressed}"/>
                                <Setter TargetName="Bd" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.99" ScaleY="0.99"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="Bd" Property="RenderTransformOrigin" Value="0.5,0.5"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ModernDataGrid (Added to fix missing resource crash) -->


        <Style x:Key="BrandSecondaryButton" TargetType="Button">
            <Setter Property="Background" Value="#FFF3F4F6"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="Foreground" Value="{StaticResource TextStrong}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="16,10"/>
            <Setter Property="MinHeight" Value="40"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFEFF2F7"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#FFD8DDE3"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFE5E7EB"/>
                                <Setter TargetName="Bd" Property="RenderTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="0.99" ScaleY="0.99"/>
                                    </Setter.Value>
                                </Setter>
                                <Setter TargetName="Bd" Property="RenderTransformOrigin" Value="0.5,0.5"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                                <Setter Property="Cursor" Value="Arrow"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DangerButton" TargetType="Button" BasedOn="{StaticResource BrandSecondaryButton}">
            <Setter Property="Foreground" Value="{StaticResource Danger}"/>
            <Setter Property="BorderBrush" Value="#FFF1B5B5"/>
        </Style>

        <Style x:Key="IconMiniButton" TargetType="Button" BasedOn="{StaticResource BrandSecondaryButton}">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="MinWidth" Value="36"/>
            <Setter Property="MinHeight" Value="36"/>
            <Setter Property="FontWeight" Value="Bold"/>
        </Style>


        <!-- DataGrid baseline -->
        <Style x:Key="ModernDataGrid" TargetType="DataGrid">
            <Setter Property="Background" Value="{StaticResource Surface}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="RowBackground" Value="White"/>
            <Setter Property="AlternatingRowBackground" Value="#FFF9FAFB"/>
            <Setter Property="GridLinesVisibility" Value="None"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="CanUserResizeRows" Value="False"/>
            <Setter Property="RowHeight" Value="36"/>
            <Setter Property="ColumnHeaderHeight" Value="38"/>
            <Setter Property="SelectionUnit" Value="FullRow"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#FFF3F4F6"/>
            <Setter Property="Foreground" Value="{StaticResource TextStrong}"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
        </Style>

        <Style TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="10,0"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="White"/>
        </Style>

        <Style TargetType="ComboBox">
            <Setter Property="Padding" Value="6,2"/>
        </Style>

        <!-- GroupBox -->
        <Style TargetType="GroupBox">
            <Setter Property="BorderBrush" Value="{StaticResource BorderSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="{StaticResource Surface}"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Opacity" Value="0.65"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="TabItem">
            <Setter Property="Padding" Value="14,8"/>
        </Style>
    </UserControl.Resources>

    <Grid Background="{StaticResource AppBg}">
        <TabControl SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">

            <!-- Wellbore Geometry -->
          
            <TabItem Header="Wellbore Geometry">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="18">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Top bar -->
                        <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Total Wellbore MD:"
                                               Foreground="{StaticResource TextMuted}"
                                               FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding TotalWellboreMD, StringFormat='  {0:F2} ft'}"
                                               Foreground="{StaticResource BrandOrange}"
                                               FontWeight="Bold"/>
                                    <TextBlock Text="   Tip: use '.' for decimals."
                                               Foreground="{StaticResource TextMuted}"
                                               FontSize="12"
                                               VerticalAlignment="Center"/>
                                </StackPanel>

                                <Button Grid.Column="1"
                                        Content="Add Section"
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Click="AddWellboreSection_Click"/>
                            </Grid>
                        </Border>

                        <!-- Error detail -->
                        <Border Grid.Row="1"
                                Margin="0,0,0,10"
                                Background="#FFFEE2E2"
                                BorderBrush="{StaticResource Danger}"
                                BorderThickness="1"
                                CornerRadius="10"
                                Padding="12"
                                Visibility="{Binding ElementName=WellboreDataGrid, Path=SelectedItem.HasValidationError, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="❌" FontSize="14" Margin="0,0,8,0" Foreground="{StaticResource Danger}"/>
                                <TextBlock Text="Error in selected row:" FontWeight="Bold" Foreground="{StaticResource Danger}" Margin="0,0,6,0"/>
                                <TextBlock Text="{Binding ElementName=WellboreDataGrid, Path=SelectedItem.ValidationMessage}"
                                           Foreground="{StaticResource Danger}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- DataGrid  -->
                        <DataGrid Grid.Row="2"
                                  x:Name="WellboreDataGrid"
                                  Style="{StaticResource ModernDataGrid}"
                                  ItemsSource="{Binding WellboreComponents}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="True"
                                  SelectionMode="Single">

                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasWarnings}" Value="True">
                                            <Setter Property="Background" Value="#FFFFF7E6"/>
                                            <Setter Property="BorderBrush" Value="#FFF59E0B"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding HasValidationError}" Value="True">
                                            <Setter Property="Background" Value="#FFFFF1F2"/>
                                            <Setter Property="BorderBrush" Value="{StaticResource Danger}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.Columns>
                                <!-- 0. Status -->
                                <DataGridTemplateColumn Header="" Width="34">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <TextBlock Text="⚠️"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           ToolTip="{Binding WarningMessage}"
                                                           Visibility="{Binding HasWarnings, Converter={StaticResource BoolToVis}}"/>
                                                <TextBlock Text="!"
                                                           Foreground="{StaticResource Danger}"
                                                           FontWeight="Bold"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           ToolTip="{Binding ValidationMessage}"
                                                           Visibility="{Binding HasValidationError, Converter={StaticResource BoolToVis}}"/>
                                            </Grid>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!-- No. Column -->
                                <DataGridTextColumn Header="No." Binding="{Binding Id}" Width="40" IsReadOnly="True"
                                                    Foreground="{StaticResource TextMuted}"/>

                                <!-- Name / Description Column -->
                                <DataGridTemplateColumn Header="Section Name" Width="200">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <TextBlock Text="Ej: Intermediate Casing"
                                                           Foreground="{StaticResource DisabledText}"
                                                           FontStyle="Italic"
                                                           VerticalAlignment="Center"
                                                           Margin="10,0,0,0"
                                                           IsHitTestVisible="False">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Name}" Value="">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Name}" Value="{x:Null}">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Padding="10,6"/>
                                            </Grid>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Padding="8,6"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <!-- Section Type Column -->
                                <DataGridTemplateColumn Header="Section Type" Width="130">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding SectionType}" VerticalAlignment="Center" Padding="10,6"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.WellboreSectionTypes, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      SelectedItem="{Binding SectionType, UpdateSourceTrigger=PropertyChanged}"
                                                      DisplayMemberPath="."/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <!-- 3. OD -->
                                <DataGridTemplateColumn Width="110">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="OD (in)" ToolTip="For OpenHole: Hole diameter. For Casing/Liner: Outer diameter."/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding OD, StringFormat=F3, TargetNullValue=''}" VerticalAlignment="Center">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasWarnings}" Value="True">
                                                                <Setter Property="Foreground" Value="{StaticResource Warn}"/>
                                                                <Setter Property="ToolTip" Value="{Binding WarningMessage}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                                <Setter Property="Foreground" Value="{StaticResource Danger}"/>
                                                                <Setter Property="ToolTip" Value="{Binding ValidationMessage}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox Text="{Binding OD, StringFormat=F3, TargetNullValue='', UpdateSourceTrigger=PropertyChanged}">
                                                <TextBox.Style>
                                                    <Style TargetType="TextBox">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                                <Setter Property="Background" Value="#FFFFF1F2"/>
                                                                <Setter Property="BorderBrush" Value="{StaticResource Danger}"/>
                                                                <Setter Property="ToolTip" Value="{Binding ValidationMessage}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBox.Style>
                                            </TextBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <!-- 4. ID -->
                                <DataGridTemplateColumn Width="110">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="ID (in)" ToolTip="For OpenHole: always 0.000. For Casing/Liner: Inner diameter."/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding ID, StringFormat=F3, TargetNullValue=''}" VerticalAlignment="Center">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding SectionType}" Value="{x:Static wb:WellboreSectionType.OpenHole}">
                                                                <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                                                <Setter Property="FontStyle" Value="Italic"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                                <Setter Property="Foreground" Value="{StaticResource Danger}"/>
                                                                <Setter Property="ToolTip" Value="{Binding ValidationMessage}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox Text="{Binding ID, StringFormat=F3, TargetNullValue='', UpdateSourceTrigger=PropertyChanged}">
                                                <TextBox.Style>
                                                    <Style TargetType="TextBox">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding SectionType}" Value="{x:Static wb:WellboreSectionType.OpenHole}">
                                                                <Setter Property="IsEnabled" Value="False"/>
                                                                <Setter Property="Background" Value="#FFF3F4F6"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                                <Setter Property="Background" Value="#FFFFF1F2"/>
                                                                <Setter Property="BorderBrush" Value="{StaticResource Danger}"/>
                                                                <Setter Property="ToolTip" Value="{Binding ValidationMessage}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBox.Style>
                                            </TextBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <!-- 5. Top MD -->
                                <DataGridTextColumn Header="Top MD (ft)" Binding="{Binding TopMD, StringFormat=F2, TargetNullValue=''}" Width="130"/>

                                <!-- 6. Bottom MD -->
                                <DataGridTextColumn Header="Bottom MD (ft)" Binding="{Binding BottomMD, StringFormat=F2, TargetNullValue=''}" Width="140"/>

                                <!-- 7. Washout -->
                                <DataGridTemplateColumn Width="130">
                                    <DataGridTemplateColumn.Header>
                                        <TextBlock Text="Washout (%)" ToolTip="Only for OpenHole. Typical 5–25%. Min 0.01%."/>
                                    </DataGridTemplateColumn.Header>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock VerticalAlignment="Center">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Text" Value="N/A"/>
                                                        <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                                        <Setter Property="FontStyle" Value="Italic"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding SectionType}" Value="{x:Static wb:WellboreSectionType.OpenHole}">
                                                                <Setter Property="Text" Value="{Binding Washout, StringFormat=F2}"/>
                                                                <Setter Property="Foreground" Value="{StaticResource TextStrong}"/>
                                                                <Setter Property="FontStyle" Value="Normal"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasWarnings}" Value="True">
                                                                <Setter Property="Foreground" Value="{StaticResource Warn}"/>
                                                                <Setter Property="ToolTip" Value="{Binding WarningMessage}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                                <Setter Property="Foreground" Value="{StaticResource Danger}"/>
                                                                <Setter Property="ToolTip" Value="{Binding ValidationMessage}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox Text="{Binding Washout, StringFormat=F2, TargetNullValue='', UpdateSourceTrigger=PropertyChanged}">
                                                <TextBox.Style>
                                                    <Style TargetType="TextBox">
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding SectionType}" Value="{x:Static wb:WellboreSectionType.OpenHole}">
                                                                <Setter Property="IsEnabled" Value="True"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                                <Setter Property="Background" Value="#FFFFF1F2"/>
                                                                <Setter Property="BorderBrush" Value="{StaticResource Danger}"/>
                                                                <Setter Property="ToolTip" Value="{Binding ValidationMessage}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBox.Style>
                                            </TextBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <!-- 8. Volume -->
                                <DataGridTextColumn Header="Volume (bbl)" Binding="{Binding Volume, StringFormat=F2}" Width="130" IsReadOnly="True"/>

                                <!-- 9. Actions -->
                                <DataGridTemplateColumn Header="Actions" Width="160">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="↑" Style="{StaticResource IconMiniButton}" ToolTip="Move Up"
                                                        Click="MoveWellboreUp_Click" Tag="{Binding}"/>
                                                <Button Content="↓" Style="{StaticResource IconMiniButton}" ToolTip="Move Down"
                                                        Click="MoveWellboreDown_Click" Tag="{Binding}"/>
                                                <Button Content="×" Style="{StaticResource IconMiniButton}" ToolTip="Delete"
                                                        Click="DeleteWellbore_Click" Tag="{Binding}" Foreground="{StaticResource Danger}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Bottom Bar -->
                        <Border Grid.Row="4" Margin="0,10,0,0" Padding="10" Background="White" BorderBrush="#E6E8EB" BorderThickness="1" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Save &amp; Next: Drill String" 
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Command="{Binding SaveAndNextCommand}"
                                        Padding="20,10"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- ========================= -->
            <!-- Drill String Geometry -->
            <!-- ========================= -->
            <TabItem Header="Drill String Geometry">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="18">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Drill String Top barra -->
                        <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,12">
                            <Grid VerticalAlignment="Center">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- MÉTRICAS -->
                                <WrapPanel Grid.Column="0"
                                        VerticalAlignment="Center"
                                        ItemHeight="26">

                                    <TextBlock Text="Total Drill String MD:"
                                            Foreground="{StaticResource TextMuted}"
                                            FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding TotalDrillStringLength, StringFormat='  {0:F2} ft'}"
                                            Foreground="{StaticResource BrandOrange}"
                                            FontWeight="Bold"
                                            Margin="4,0,16,0"/>

                                    <TextBlock Text="Depth to Bottom:"
                                            Foreground="{StaticResource TextMuted}"
                                            FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding DepthDifferential, StringFormat='  {0:+0.00;-0.00;0.00} ft'}"
                                            FontWeight="Bold"
                                            Foreground="{Binding DepthDifferentialColor}"
                                            Margin="4,0,16,0"/>

                                    <TextBlock FontWeight="SemiBold"
                                            Foreground="{StaticResource Success}"
                                            Margin="0,0,16,0"
                                            Visibility="{Binding DepthDifferentialStatus, Converter={StaticResource NullToVis}}"
                                            Text="{Binding DepthDifferentialStatus}"/>

                                    <TextBlock Text="Total Wellbore MD:"
                                            Foreground="{StaticResource TextMuted}"
                                            FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding TotalWellboreMD, StringFormat='  {0:F2} ft'}"
                                            Foreground="{StaticResource BrandOrange}"
                                            FontWeight="Bold"/>
                                </WrapPanel>

                                <!-- ACCIONES -->
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            VerticalAlignment="Center">

                                    <Button Content="Ajustar MD al Fondo"
                                            Style="{StaticResource BrandPrimaryButton}"
                                            Command="{Binding ForceToBottomCommand}"
                                            IsEnabled="{Binding CanForceToBottom}"
                                            Margin="0,0,10,0"/>

                                    <Button Content="Add Component"
                                            Style="{StaticResource BrandPrimaryButton}"
                                            MinWidth="140"
                                            Click="AddDrillStringComponent_Click"/>
                                </StackPanel>
                            </Grid>
                        </Border>


                        <!-- Área de Trabajo Principal (Tabla + Visualizador) -->
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <DockPanel Grid.Column="0">
                                <!-- Error detail -->
                                <Border DockPanel.Dock="Top"
                                        Margin="0,0,0,10"
                                        Background="#FFFEE2E2"
                                        BorderBrush="{StaticResource Danger}"
                                        BorderThickness="1"
                                        CornerRadius="10"
                                        Padding="12"
                                        Visibility="{Binding ElementName=DrillStringDataGrid, Path=SelectedItem.HasValidationError, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="❌" FontSize="14" Margin="0,0,8,0" Foreground="{StaticResource Danger}"/>
                                        <TextBlock Text="Error in selected row:" FontWeight="Bold" Foreground="{StaticResource Danger}" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding ElementName=DrillStringDataGrid, Path=SelectedItem.ValidationMessage}"
                                                   Foreground="{StaticResource Danger}" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Border>

                                <!-- DataGrid -->
                                <DataGrid x:Name="DrillStringDataGrid"
                                          Style="{StaticResource ModernDataGrid}"
                                          ItemsSource="{Binding DrillStringComponents}"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          CanUserDeleteRows="True"
                                          SelectionMode="Single"
                                          CanUserReorderColumns="False"
                                          AllowDrop="True"
                                          Drop="DrillStringDataGrid_Drop"
                                          PreviewMouseLeftButtonDown="DrillStringDataGrid_PreviewMouseLeftButtonDown"
                                          PreviewMouseMove="DrillStringDataGrid_PreviewMouseMove">

                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasValidationError}" Value="True">
                                            <Setter Property="Background" Value="#FFFFF1F2"/>
                                            <Setter Property="BorderBrush" Value="{StaticResource Danger}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                            <Setter Property="Background" Value="#FFEAFBF0"/>
                                            <Setter Property="BorderBrush" Value="{StaticResource Success}"/>
                                            <Setter Property="BorderThickness" Value="2"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="" Width="34">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="❌"
                                                       Foreground="{StaticResource Danger}"
                                                       FontWeight="Bold"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       ToolTip="{Binding ValidationMessage}"
                                                       Visibility="{Binding HasValidationError, Converter={StaticResource BoolToVis}}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="No." Binding="{Binding Id}" Width="60" IsReadOnly="True"
                                                    Foreground="{StaticResource TextMuted}"/>

                                <!-- Component Name with Placeholder -->
                                <DataGridTemplateColumn Header="Component Name" Width="200">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <TextBlock Text="Ej: MWD - TeleScope"
                                                           Foreground="{StaticResource DisabledText}"
                                                           FontStyle="Italic"
                                                           VerticalAlignment="Center"
                                                           Margin="10,0,0,0"
                                                           IsHitTestVisible="False">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Name}" Value="">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Name}" Value="{x:Null}">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Padding="10,6"/>
                                            </Grid>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" Padding="8,6"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Type" Width="160">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding ComponentType}" VerticalAlignment="Center" Padding="10,6"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.ComponentTypes, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      SelectedItem="{Binding ComponentType, UpdateSourceTrigger=PropertyChanged}"
                                                      DisplayMemberPath="."/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="Length (ft)" Binding="{Binding Length, StringFormat=F2}" Width="130"/>
                                <DataGridTextColumn Header="OD (in)" Binding="{Binding OD, StringFormat=F3, UpdateSourceTrigger=PropertyChanged}" Width="110"/>
                                <DataGridTextColumn Header="ID (in)" Binding="{Binding ID, StringFormat=F3, UpdateSourceTrigger=PropertyChanged}" Width="110"/>
                                <DataGridTextColumn Header="Volume (bbl)" Binding="{Binding InternalVolume, StringFormat=F2}" Width="130" IsReadOnly="True"/>

                                <DataGridTemplateColumn Header="Actions" Width="240">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="Config" Style="{StaticResource BrandSecondaryButton}"
                                                        Padding="12,4" Margin="0,0,6,0"
                                                        ToolTip="Configure Component"
                                                        Click="ConfigureComponent_Click"
                                                        Tag="{Binding}"/>
                                                <Button Content="↑" Style="{StaticResource IconMiniButton}" ToolTip="Move Up"
                                                        Click="MoveDrillStringUp_Click" Tag="{Binding}"/>
                                                <Button Content="↓" Style="{StaticResource IconMiniButton}" ToolTip="Move Down"
                                                        Click="MoveDrillStringDown_Click" Tag="{Binding}"/>
                                                <Button Content="×" Style="{StaticResource IconMiniButton}" ToolTip="Delete"
                                                        Click="DeleteDrillString_Click" Tag="{Binding}" Foreground="{StaticResource Danger}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>

                    <!-- Visualizador Gráfico Proporcional -->
                    <Border Grid.Column="1" 
                            Width="300"
                            Margin="12,0,0,0"
                            Style="{StaticResource CardBorder}"
                            Background="White">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <Border Background="#FFF3F4F6" CornerRadius="8,8,0,0" Padding="10">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="BHA SCHEMATIC" FontWeight="Bold" Foreground="{StaticResource BrandBlue}"/>
                                    <Border Margin="10,0,0,0" 
                                            Padding="6,2" 
                                            CornerRadius="4"
                                            Background="{Binding IsOnBottom, Converter={StaticResource BoolToGreenRedConverter}}"
                                            Visibility="{Binding IsOnBottom, Converter={StaticResource BoolToVis}}">
                                        <TextBlock Text="ON BOTTOM" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <geometry:BhaSchematicView x:Name="BhaVisualizer" 
                                                            Grid.Row="1"
                                                            Margin="10"/>

                            <!-- No Data Overlay -->
                            <TextBlock Grid.Row="1" 
                                       Text="No BHA components defined" 
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{StaticResource TextMuted}"
                                       Visibility="{Binding DrillStringComponents.Count, Converter={StaticResource CollectionToVis}, ConverterParameter=Inverse}"/>
                        </Grid>
                    </Border>
                </Grid>

                        <!-- Bottom Bar -->
                        <Border Grid.Row="4" Margin="0,10,0,0" Padding="10" Background="White" BorderBrush="#E6E8EB" BorderThickness="1" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Save &amp; Next: Survey" 
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Command="{Binding SaveAndNextCommand}"
                                        Padding="20,10"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- ========================= -->
            <!-- Survey -->
            <!-- ========================= -->
            <TabItem Header="Survey">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="18">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto" MinHeight="250"/> <!-- DataGrid Area -->
                            <RowDefinition Height="Auto"/> <!-- Gap/Controls -->
                            <RowDefinition Height="Auto" MinHeight="350"/> <!-- Chart Area -->
                            <RowDefinition Height="Auto"/> <!-- Bottom Bar -->
                        </Grid.RowDefinitions>

                        <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0"
                                           Text="Survey points define the trajectory. Keep MD increasing."
                                           Foreground="{StaticResource TextMuted}"
                                           VerticalAlignment="Center"/>

                                <Button Grid.Column="1"
                                        Content="Load from Excel"
                                        Style="{StaticResource BrandSecondaryButton}"
                                        Margin="0,0,10,0"
                                        Click="LoadSurveyFromExcel_Click"/>

                                <Button Grid.Column="2"
                                        Content="Add Survey Point"
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Click="AddSurveyPoint_Click"/>
                            </Grid>
                        </Border>

                        <DataGrid Grid.Row="1"
                                  x:Name="SurveyDataGrid"
                                  Style="{StaticResource ModernDataGrid}"
                                  ItemsSource="{Binding SurveyPoints}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="True"
                                  SelectionMode="Single"
                                  MaxHeight="400">

                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                            <Setter Property="Background" Value="#FFFFF1F2"/>
                                            <Setter Property="BorderBrush" Value="{StaticResource Danger}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>

                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="" Width="34">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="!"
                                                       Foreground="{StaticResource Danger}"
                                                       FontWeight="Bold"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       ToolTip="{Binding ValidationMessage}"
                                                       Visibility="{Binding HasErrors, Converter={StaticResource BoolToVis}}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="60" IsReadOnly="True"/>

                                <DataGridTextColumn Header="MD (ft)" Binding="{Binding MD, StringFormat=F2, TargetNullValue=''}" Width="130">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Measured Depth along wellbore (INPUT)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                </DataGridTextColumn>

                                <!-- TVD - READ-ONLY CALCULATED -->
                                <DataGridTextColumn Header="TVD (ft)" Binding="{Binding TVD, StringFormat=F2}" Width="130" IsReadOnly="True">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="True Vertical Depth (AUTO-CALCULATED)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Background" Value="#FFF3F4F6"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                            <Setter Property="Padding" Value="10,0"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Hole Angle (°)" Binding="{Binding HoleAngle, StringFormat=F4, TargetNullValue=''}" Width="160">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Inclination from vertical, 0-93° (INPUT)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                </DataGridTextColumn>

                                <DataGridTextColumn Header="Azimuth (°)" Binding="{Binding Azimuth, StringFormat=F4, TargetNullValue=''}" Width="140">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Direction from North, 0-360° (INPUT)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                </DataGridTextColumn>

                                <!-- Northing - READ-ONLY CALCULATED -->
                                <DataGridTextColumn Header="Northing (ft)" Binding="{Binding Northing, StringFormat=F2}" Width="140" IsReadOnly="True">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="North coordinate (AUTO-CALCULATED)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Background" Value="#FFF3F4F6"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                            <Setter Property="Padding" Value="10,0"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Easting - READ-ONLY CALCULATED -->
                                <DataGridTextColumn Header="Easting (ft)" Binding="{Binding Easting, StringFormat=F2}" Width="140" IsReadOnly="True">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="East coordinate (AUTO-CALCULATED)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Background" Value="#FFF3F4F6"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                            <Setter Property="Padding" Value="10,0"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Vertical Section - READ-ONLY CALCULATED -->
                                <DataGridTextColumn Header="Horiz. Disp. (ft)" Binding="{Binding VerticalSection, StringFormat=F2}" Width="160" IsReadOnly="True">
                                    <DataGridTextColumn.HeaderStyle>
                                        <Style TargetType="DataGridColumnHeader">
                                            <Setter Property="ToolTip" Value="Horizontal Displacement from origin (AUTO-CALCULATED)"/>
                                        </Style>
                                    </DataGridTextColumn.HeaderStyle>
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Background" Value="#FFF3F4F6"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                            <Setter Property="Padding" Value="10,0"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTemplateColumn Header="Actions" Width="160">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="↑" Style="{StaticResource IconMiniButton}" ToolTip="Move Up"
                                                        Click="MoveSurveyUp_Click" Tag="{Binding}"/>
                                                <Button Content="↓" Style="{StaticResource IconMiniButton}" ToolTip="Move Down"
                                                        Click="MoveSurveyDown_Click" Tag="{Binding}"/>
                                                <Button Content="×" Style="{StaticResource IconMiniButton}" ToolTip="Delete"
                                                        Click="DeleteSurvey_Click" Tag="{Binding}" Foreground="{StaticResource Danger}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <TextBlock Grid.Row="2" Text="Trajectory Profile (Vertical Section)" Style="{StaticResource CardHeader}" Margin="0,15,0,5"/>

                        <!-- Survey Chart -->
                        <Border Grid.Row="3" 
                                Style="{StaticResource CardBorder}" 
                                Padding="0" 
                                ClipToBounds="True" 
                                Height="400">
                            <lvc:CartesianChart Series="{Binding SurveySeriesCollection}" 
                                                LegendLocation="Bottom" 
                                                Zoom="None">
                                <lvc:CartesianChart.AxisX>
                                    <lvc:Axis Title="Vertical Section (ft)" Foreground="{StaticResource TextStrong}">
                                        <lvc:Axis.Separator>
                                            <lvc:Separator Stroke="{StaticResource BorderSoft}"/>
                                        </lvc:Axis.Separator>
                                    </lvc:Axis>
                                </lvc:CartesianChart.AxisX>
                                <lvc:CartesianChart.AxisY>
                                    <lvc:Axis Title="TVD (ft)" Foreground="{StaticResource TextStrong}" LabelFormatter="{Binding YAxisLabelFormatter}">
                                        <lvc:Axis.Separator>
                                            <lvc:Separator Stroke="{StaticResource BorderSoft}"/>
                                        </lvc:Axis.Separator>
                                    </lvc:Axis>
                                </lvc:CartesianChart.AxisY>
                            </lvc:CartesianChart>
                        </Border>

                        <!-- Bottom Bar -->
                        <Border Grid.Row="4" Margin="0,10,0,0" Padding="10" Background="White" BorderBrush="#E6E8EB" BorderThickness="1" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Save &amp; Next: Thermal Gradient" 
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Command="{Binding SaveAndNextCommand}"
                                        Padding="20,10"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- ========================= -->
            <!-- Thermal Gradient -->
            <!-- ========================= -->
            <TabItem Header="Thermal Gradient">
                <Grid Margin="18">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Border Grid.Row="0" Style="{StaticResource CardBorder}">
                        <geometry:ThermalGradientView DataContext="{Binding ThermalGradientViewModel}"/>
                    </Border>

                    <!-- Bottom Bar -->
                    <Border Grid.Row="1" Margin="0,10,0,0" Padding="10" Background="White" BorderBrush="#E6E8EB" BorderThickness="1" CornerRadius="8">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="Save &amp; Next: Well Test" 
                                    Style="{StaticResource BrandPrimaryButton}"
                                    Command="{Binding SaveAndNextCommand}"
                                    Padding="20,10"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </TabItem>

            <!-- ========================= -->
            <!-- Well Test -->
            <!-- ========================= -->
            <TabItem Header="Well Test">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="18">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Dashboard de Seguridad (MAASP / Kick Tolerance) -->
                        <Grid Grid.Row="0" Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="1.5*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Medidor MAASP -->
                            <Border Grid.Column="0" Style="{StaticResource CardBorder}" Margin="0,0,10,0" Padding="15">
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="MAASP" Foreground="{StaticResource TextMuted}" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                                    <lvc:Gauge Value="{Binding MAASP}"
                                               From="0" To="3000"
                                               LabelsVisibility="Collapsed"
                                               Height="120"
                                               InnerRadius="45"
                                               GaugeBackground="{StaticResource BorderSoft}"
                                               Foreground="{StaticResource BrandBlueGradient}"/>
                                    <TextBlock Text="{Binding MAASP, StringFormat='{}{0:N0} psi'}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                                    <TextBlock Text="Max Surface Pressure" FontSize="11" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Medidor Kick Tolerance -->
                            <Border Grid.Column="1" Style="{StaticResource CardBorder}" Margin="0,0,10,0" Padding="15">
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="Kick Tolerance" Foreground="{StaticResource TextMuted}" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                                    <lvc:Gauge Value="{Binding KickTolerance}"
                                               From="0" To="100"
                                               LabelsVisibility="Collapsed"
                                               Height="120"
                                               InnerRadius="45"
                                               GaugeBackground="{StaticResource BorderSoft}"
                                               Foreground="{StaticResource BrandOrangeGradient}"/>
                                    <TextBlock Text="{Binding KickTolerance, StringFormat='{}{0:N1} bbl'}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                                    <TextBlock Text="Max Influx Volume" FontSize="11" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Entradas y Status -->
                            <Border Grid.Column="2" Style="{StaticResource CardBorder}" Padding="15">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Text="Drilling Parameters" FontWeight="Bold" Margin="0,0,0,12"/>
                                    
                                    <UniformGrid Grid.Row="1" Columns="2">
                                        <StackPanel Margin="0,0,10,10">
                                            <TextBlock Text="Current Mud Weight" Foreground="{StaticResource TextMuted}" FontSize="12"/>
                                            <TextBox Text="{Binding CurrentMudWeight, UpdateSourceTrigger=PropertyChanged, StringFormat=F2}" 
                                                     FontSize="16" FontWeight="SemiBold" Padding="5"/>
                                            <TextBlock Text="ppg" FontSize="10" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Right"/>
                                        </StackPanel>

                                        <StackPanel Margin="0,0,0,10">
                                            <TextBlock Text="Influx Gradient" Foreground="{StaticResource TextMuted}" FontSize="12"/>
                                            <TextBlock Text="0.10 psi/ft" FontSize="16" FontWeight="SemiBold" Margin="0,5,0,0"/>
                                            <TextBlock Text="(Safety Standard)" FontSize="10" Foreground="{StaticResource TextMuted}" HorizontalAlignment="Right"/>
                                        </StackPanel>

                                        <Button Grid.Column="0"
                                                Content="+ Add New Well Test"
                                                Style="{StaticResource BrandPrimaryButton}"
                                                Click="AddWellTest_Click"
                                                Height="36"
                                                Margin="0,5,5,0"/>
                                        
                                        <Button Content="Clear All"
                                                Style="{StaticResource BrandSecondaryButton}"
                                                Height="36"
                                                Margin="5,5,0,0"/>

                                        <Button Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                Content="📥 Import LOT CSV Data"
                                                Style="{StaticResource BrandSecondaryButton}"
                                                Command="{Binding ImportPumpDataCommand}"
                                                Height="36"
                                                Margin="0,10,0,0"
                                                ToolTip="Import pump pressure data for the selected Leak Off Test"/>
                                    </UniformGrid>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- Gráficas de Diagnóstico -->
                        <Grid Grid.Row="1" Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="3*"/>
                                <ColumnDefinition Width="2*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Chart 1: Pressure Profiler -->
                            <Border Grid.Column="0" Style="{StaticResource CardBorder}" Margin="0,0,6,0" MinHeight="350">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Text="Pressure vs. Depth Profile" FontWeight="Bold" Margin="0,0,0,10"/>
                                    
                                    <lvc:CartesianChart Grid.Row="1" Series="{Binding SafetySeriesCollection}" LegendLocation="Bottom">
                                        <lvc:CartesianChart.AxisX>
                                            <lvc:Axis Title="Equivalent Mud Weight (ppg)" MinValue="8" MaxValue="22">
                                                <lvc:Axis.Separator>
                                                    <lvc:Separator Step="1"/>
                                                </lvc:Axis.Separator>
                                            </lvc:Axis>
                                        </lvc:CartesianChart.AxisX>
                                        <lvc:CartesianChart.AxisY>
                                            <lvc:Axis Title="True Vertical Depth (ft)" LabelFormatter="{Binding YAxisLabelFormatter}"/>
                                        </lvc:CartesianChart.AxisY>
                                    </lvc:CartesianChart>
                                </Grid>
                            </Border>

                            <!-- Chart 2: LOT Pump Curve -->
                            <Border Grid.Column="1" Style="{StaticResource CardBorder}" Margin="6,0,0,0">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                        <TextBlock Text="LOT: Pump Pressure" FontWeight="Bold"/>
                                        <TextBlock Text=" (Selected Test)" FontSize="10" Foreground="{StaticResource TextMuted}" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                    </StackPanel>
                                    
                                    <lvc:CartesianChart Grid.Row="1" Series="{Binding LotSeriesCollection}">
                                        <lvc:CartesianChart.AxisX>
                                            <lvc:Axis Title="Volume / Time" />
                                        </lvc:CartesianChart.AxisX>
                                        <lvc:CartesianChart.AxisY>
                                            <lvc:Axis Title="Pump Pressure (psi)" />
                                        </lvc:CartesianChart.AxisY>
                                    </lvc:CartesianChart>

                                    <TextBlock Grid.Row="1" Text="Select a Leak Off row and import CSV to see the plot" 
                                               Foreground="{StaticResource TextMuted}" 
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               Visibility="{Binding LotSeriesCollection.Count, Converter={StaticResource CollectionToVis}, ConverterParameter=Inverse}"/>
                                </Grid>
                            </Border>
                        </Grid>

                        <DataGrid Grid.Row="2"
                                  x:Name="WellTestDataGrid"
                                  Style="{StaticResource ModernDataGrid}"
                                  ItemsSource="{Binding WellTests}"
                                  SelectedItem="{Binding SelectedWellTest}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="True"
                                  SelectionMode="Single">

                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="60" IsReadOnly="True"/>

                                <DataGridTemplateColumn Header="Section" Width="180">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Section}" VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.WellboreSectionNames, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      SelectedItem="{Binding Section, UpdateSourceTrigger=PropertyChanged}"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn Header="Test Type" Width="220">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding TypeString}" VerticalAlignment="Center" Padding="10,6"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding DataContext.WellTestTypes, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                      SelectedItem="{Binding TypeString, UpdateSourceTrigger=PropertyChanged}"
                                                      DisplayMemberPath="."/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTextColumn Header="TVD (ft)" Binding="{Binding TVD, StringFormat=F2}" Width="120"/>
                                <DataGridTextColumn Header="Pressure (psi)" Binding="{Binding TestPressurePsi, StringFormat=F0, UpdateSourceTrigger=PropertyChanged}" Width="130"/>
                                <DataGridTextColumn Header="Final EMW (ppg)" Binding="{Binding TestValue, StringFormat=F2}" Width="150"/>
                                <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*"/>

                                <DataGridTemplateColumn Header="Actions" Width="160">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="↑" Style="{StaticResource IconMiniButton}" ToolTip="Move Up"
                                                        Click="MoveWellTestUp_Click" Tag="{Binding}"/>
                                                <Button Content="↓" Style="{StaticResource IconMiniButton}" ToolTip="Move Down"
                                                        Click="MoveWellTestDown_Click" Tag="{Binding}"/>
                                                <Button Content="×" Style="{StaticResource IconMiniButton}" ToolTip="Delete"
                                                        Click="DeleteWellTest_Click" Tag="{Binding}" Foreground="{StaticResource Danger}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <!-- Bottom Bar -->
                        <Border Grid.Row="3" Margin="0,10,0,0" Padding="10" Background="White" BorderBrush="#E6E8EB" BorderThickness="1" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Save &amp; Next: Summary" 
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Command="{Binding SaveAndNextCommand}"
                                        Padding="20,10"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- ========================= -->
            <!-- Summary (incluye VisualSchemeCanvas) -->
            <!-- ========================= -->
            <TabItem Header="Summary">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid Margin="18">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <GroupBox Grid.Row="0" Header="Volume Summary">
                            <Grid Margin="10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <StackPanel Grid.Column="0" Margin="10">
                                    <TextBlock Text="Total Wellbore Volume" Foreground="{StaticResource TextMuted}" FontWeight="SemiBold"
                                               ToolTip="V_well = π * (ID_well/2)² * Length"/>
                                    <TextBlock Text="{Binding TotalWellboreVolume, StringFormat='{}{0:F2} bbl'}"
                                               FontSize="22" FontWeight="Bold" Foreground="{StaticResource BrandOrange}"/>
                                </StackPanel>

                                <StackPanel Grid.Column="1" Margin="10">
                                    <TextBlock Text="Total Drill String Volume" Foreground="{StaticResource TextMuted}" FontWeight="SemiBold"
                                               ToolTip="V_string = π * (ID_pipe/2)² * Length (Internal Capacity)"/>
                                    <TextBlock Text="{Binding TotalDrillStringVolume, StringFormat='{}{0:F2} bbl'}"
                                               FontSize="22" FontWeight="Bold" Foreground="{StaticResource BrandOrange}"/>
                                    <lvc:Gauge Value="{Binding StringVolumePercent}" Height="120" Width="120" 
                                               From="0" To="100" InnerRadius="40"
                                               GaugeBackground="#F3F4F6"
                                               LabelsVisibility="Collapsed" />
                                </StackPanel>

                                <StackPanel Grid.Column="2" Margin="10">
                                    <TextBlock Text="Total Annular Volume" Foreground="{StaticResource TextMuted}" FontWeight="SemiBold"
                                               ToolTip="V_ann = π * (ID_well² - OD_pipe²) / 4 * Length"/>
                                    <TextBlock Text="{Binding TotalAnnularVolume, StringFormat='{}{0:F2} bbl'}"
                                               FontSize="22" FontWeight="Bold" Foreground="{StaticResource BrandOrange}"/>
                                    <lvc:Gauge Value="{Binding AnnularVolumePercent}" Height="120" Width="120" 
                                               From="0" To="100" InnerRadius="40"
                                               GaugeBackground="#F3F4F6"
                                               LabelsVisibility="Collapsed" />
                                </StackPanel>

                                <StackPanel Grid.Column="3" Margin="10">
                                    <TextBlock Text="Total Circulation Volume" Foreground="{StaticResource TextMuted}" FontWeight="SemiBold"
                                               ToolTip="V_total = V_annulus + V_drillstring"/>
                                    <TextBlock Text="{Binding TotalCirculationVolume, StringFormat='{}{0:F2} bbl'}"
                                               FontSize="22" FontWeight="Bold" Foreground="{StaticResource BrandOrange}"/>
                                </StackPanel>
                            </Grid>
                        </GroupBox>

                        <GroupBox Grid.Row="1" Header="Annular Volume Details">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <DataGrid Grid.Column="0"
                                          ItemsSource="{Binding Source={StaticResource AnnularDetailsView}}"
                                      Style="{StaticResource ModernDataGrid}"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      IsReadOnly="True"
                                      MaxHeight="400"
                                      Margin="10">
                                <DataGrid.GroupStyle>
                                    <GroupStyle>
                                        <GroupStyle.HeaderTemplate>
                                            <DataTemplate>
                                                <StackPanel Background="#F3F4F6" Margin="0,5,0,0">
                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" Padding="10,5" Foreground="#1F2937"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </GroupStyle.HeaderTemplate>
                                    </GroupStyle>
                                </DataGrid.GroupStyle>
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Volume}" Value="0">
                                                <Setter Property="Background" Value="#FFFDE68A"/> <!-- Yellow-200 -->
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGrid.RowStyle>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Stage" Binding="{Binding Stage}" Width="100"/>
                                    <DataGridTextColumn Header="Type" Binding="{Binding SectionType}" Width="80"/>
                                    <DataGridTextColumn Header="Section/Component Name" Binding="{Binding Name}" Width="220"/>
                                    <DataGridTextColumn Header="Wellbore ID (in)" Binding="{Binding WellboreID, StringFormat=F3}" Width="140"/>
                                    <DataGridTextColumn Header="Drill String OD (in)" Binding="{Binding DrillStringOD, StringFormat=F3}" Width="160"/>
                                    <DataGridTextColumn Header="Depth Range (ft)" Binding="{Binding DepthRange}" Width="160"/>
                                    <DataGridTextColumn Header="Annular Volume (bbl)" Binding="{Binding Volume, StringFormat=F2}" Width="170"/>
                                </DataGrid.Columns>
                            </DataGrid>

                        <!-- Visualizador BHA Lateral -->
                        <Border Grid.Column="1" 
                                Style="{StaticResource CardBorder}" 
                                Margin="15,0,0,0" 
                                Padding="5" 
                                Width="180" 
                                Background="White">
                            <StackPanel>
                                <Border Background="{StaticResource BrandOrange}" Height="4" CornerRadius="2,2,0,0"/>
                                <TextBlock Text="BHA VISUALIZER" 
                                           FontSize="10" FontWeight="Bold" 
                                           HorizontalAlignment="Center" 
                                           Margin="0,8,0,5"/>
                                
                                <Separator Background="#E6E8EB" Margin="10,0"/>
                                
                                <Viewbox Stretch="Uniform" StretchDirection="DownOnly" MaxHeight="600">
                                    <geometry:BhaSchematicView x:Name="BhaVisualizerSummary" MinWidth="140"/>
                                </Viewbox>
                                
                                <Border Margin="10" Background="#F3F4F6" CornerRadius="6" Padding="8">
                                    <StackPanel>
                                        <TextBlock Text="Status" FontSize="9" FontWeight="Bold" Foreground="{StaticResource TextMuted}"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                            <Ellipse Width="8" Height="8" Fill="{Binding IsOnBottom, Converter={StaticResource BoolToGreenRedConverter}}" Margin="0,0,6,0"/>
                                            <TextBlock Text="{Binding BitToBottom, Converter={StaticResource BitStatusConverter}}" FontSize="11" FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </Grid>
                        </GroupBox>


                        <!-- Bottom Bar -->
                        <Border Grid.Row="2" Margin="0,10,0,0" Padding="10" Background="White" BorderBrush="#E6E8EB" BorderThickness="1" CornerRadius="8">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="Finalize Geometry" 
                                        Style="{StaticResource BrandPrimaryButton}"
                                        Background="{StaticResource Success}"
                                        BorderBrush="{StaticResource Success}"
                                        Command="{Binding FinalizeGeometryCommand}"
                                        Padding="20,10"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

        </TabControl>
    </Grid>
</UserControl>
